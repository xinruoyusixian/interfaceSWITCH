<%+header%>

<div class="cbi-map">
    <h2 name="content">网络切换器日志</h2>
    
    <div class="cbi-map-descr">
        查看网络切换器的操作日志和系统状态。
    </div>
    
    <fieldset class="cbi-section">
        <legend>日志控制</legend>
        <div class="cbi-value">
            <label class="cbi-value-title">日志操作</label>
            <div class="cbi-value-field">
                <button class="cbi-button cbi-button-reload" onclick="refreshLogs()" style="margin-right: 5px;">
                    刷新日志
                </button>
                <button class="cbi-button cbi-button-reset" onclick="clearLogs()">
                    清空日志
                </button>
                <button class="cbi-button cbi-button-download" onclick="downloadLogs()" style="margin-left: 5px;">
                    下载日志
                </button>
            </div>
        </div>
        
        <div class="cbi-value">
            <label class="cbi-value-title">自动刷新</label>
            <div class="cbi-value-field">
                <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh()" />
                <label for="auto-refresh">每30秒自动刷新</label>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend>系统日志</legend>
        <pre id="log-content" style="min-height: 400px; background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; font-size: 12px; overflow-y: auto;">正在加载日志...</pre>
    </fieldset>
</div>

<script>
var autoRefreshInterval = null;

// 页面加载时初始化
window.onload = function() {
    refreshLogs();
};

// 刷新日志
function refreshLogs() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=luci.dispatcher.build_url("admin/services/network_switcher/get_logs")%>', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            try {
                var response = JSON.parse(xhr.responseText);
                document.getElementById('log-content').textContent = response.logs;
                // 滚动到底部
                var logElement = document.getElementById('log-content');
                logElement.scrollTop = logElement.scrollHeight;
            } catch (e) {
                console.error('解析日志失败:', e);
            }
        }
    };
    xhr.send();
}

// 清空日志
function clearLogs() {
    if (!confirm('确定要清空日志吗？')) {
        return;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=luci.dispatcher.build_url("admin/services/network_switcher/clear_logs")%>', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            refreshLogs();
        }
    };
    xhr.send();
}

// 下载日志
function downloadLogs() {
    var logContent = document.getElementById('log-content').textContent;
    var blob = new Blob([logContent], { type: 'text/plain' });
    var url = URL.createObjectURL(blob);
    
    var a = document.createElement('a');
    a.href = url;
    a.download = 'network_switcher_' + new Date().toISOString().replace(/[:.]/g, '-') + '.log';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 切换自动刷新
function toggleAutoRefresh() {
    var checkbox = document.getElementById('auto-refresh');
    
    if (checkbox.checked) {
        autoRefreshInterval = setInterval(refreshLogs, 30000);
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
}

// 页面卸载时清除定时器
window.onbeforeunload = function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
};
</script>

<%+footer%>
