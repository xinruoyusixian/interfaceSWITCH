name: Build Network Switcher IPK

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '22.03.5'
        type: choice
        options:
          - '22.03.5'
          - '21.02.7'
      architecture:
        description: 'è®¾å¤‡æ¶æ„'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - 'aarch64_generic'
          - 'x86_64'

env:
  PACKAGE_NAME: network-switcher

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Debug - List files
      run: |
        echo "=== ä»“åº“æ–‡ä»¶ç»“æ„ ==="
        find . -type f -name "*.mk" -o -name "Makefile" -o -name "*.md" | head -20
        echo "=== å½“å‰ç›®å½• ==="
        pwd
        ls -la

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          libssl-dev \
          xsltproc \
          wget \
          unzip \
          python3 \
          python3-setuptools \
          rsync

    - name: Download OpenWrt SDK
      run: |
        echo "ä¸‹è½½OpenWrt SDK..."
        
        if [ "${{ inputs.architecture }}" = "x86_64" ]; then
          SDK_URL="https://downloads.openwrt.org/releases/${{ inputs.openwrt_version }}/targets/x86/64/openwrt-sdk-${{ inputs.openwrt_version }}-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
        elif [ "${{ inputs.architecture }}" = "aarch64_generic" ]; then
          SDK_URL="https://downloads.openwrt.org/releases/${{ inputs.openwrt_version }}/targets/armvirt/64/openwrt-sdk-${{ inputs.openwrt_version }}-aarch64_generic_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
        else
          echo "ä¸æ”¯æŒçš„æ¶æ„: ${{ inputs.architecture }}"
          exit 1
        fi
        
        echo "SDK URL: $SDK_URL"
        wget -q --show-progress -O sdk.tar.xz "$SDK_URL"
        
        # è§£å‹SDK
        tar -xf sdk.tar.xz
        SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -1)
        
        if [ -z "$SDK_DIR" ]; then
          echo "æ— æ³•æ‰¾åˆ°SDKç›®å½•!"
          tar -tf sdk.tar.xz | head -10
          exit 1
        fi
        
        echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV
        echo "ä½¿ç”¨SDK: $SDK_DIR"

    - name: Prepare package
      run: |
        echo "å‡†å¤‡åŒ…ç›®å½•..."
        
        # åˆ›å»ºåŒ…ç›®å½•
        mkdir -p $SDK_DIR/package/$PACKAGE_NAME
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
        echo "å¤åˆ¶æ–‡ä»¶åˆ°åŒ…ç›®å½•..."
        cp -r ./* $SDK_DIR/package/$PACKAGE_NAME/ 2>/dev/null || true
        
        # æ˜¾ç¤ºå¤åˆ¶çš„æ–‡ä»¶
        echo "åŒ…ç›®å½•å†…å®¹:"
        ls -la $SDK_DIR/package/$PACKAGE_NAME/ | head -10

    - name: Build package
      working-directory: $SDK_DIR
      run: |
        echo "å¼€å§‹ç¼–è¯‘è¿‡ç¨‹..."
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # åˆ›å»ºé…ç½®
        echo "CONFIG_PACKAGE_$PACKAGE_NAME=m" > .config
        make defconfig
        
        echo "ç¼–è¯‘é…ç½®:"
        cat .config | grep $PACKAGE_NAME || echo "åŒ…æœªåœ¨é…ç½®ä¸­æ‰¾åˆ°"
        
        # ç¼–è¯‘åŒ…
        echo "å¼€å§‹ç¼–è¯‘åŒ… $PACKAGE_NAME..."
        make package/$PACKAGE_NAME/compile V=s -j$(nproc)
        
        # æ£€æŸ¥ç»“æœ
        if [ $? -eq 0 ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ!"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥!"
          exit 1
        fi

    - name: Find and collect IPK
      run: |
        echo "æŸ¥æ‰¾ç”Ÿæˆçš„IPKæ–‡ä»¶..."
        
        # åœ¨å¤šä¸ªå¯èƒ½çš„ä½ç½®æŸ¥æ‰¾
        IPK_PATH=$(find $SDK_DIR -name "*${PACKAGE_NAME}*.ipk" -type f | head -1)
        
        if [ -n "$IPK_PATH" ]; then
          echo "âœ… æ‰¾åˆ°IPKæ–‡ä»¶: $IPK_PATH"
          echo "æ–‡ä»¶å¤§å°: $(du -h $IPK_PATH | cut -f1)"
          echo "IPK_PATH=$IPK_PATH" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°IPKæ–‡ä»¶!"
          echo "æœç´¢è·¯å¾„:"
          find $SDK_DIR -name "*.ipk" -type f | head -10
          exit 1
        fi

    - name: Upload IPK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-${{ inputs.openwrt_version }}-${{ inputs.architecture }}
        path: ${{ env.IPK_PATH }}
        retention-days: 30

    - name: Build summary
      if: always()
      run: |
        echo "=== æ„å»ºæ‘˜è¦ ==="
        echo "åŒ…åç§°: $PACKAGE_NAME"
        echo "OpenWrtç‰ˆæœ¬: ${{ inputs.openwrt_version }}"
        echo "ç›®æ ‡æ¶æ„: ${{ inputs.architecture }}"
        echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… æ„å»ºæˆåŠŸ!"
          echo "ğŸ“¦ IPKæ–‡ä»¶: $IPK_PATH"
        else
          echo "âŒ æ„å»ºå¤±è´¥!"
        fi
