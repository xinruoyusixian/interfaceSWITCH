name: Build OpenWrt IPK

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt版本'
        required: true
        default: '22.03.5'
        type: choice
        options:
        - '22.03.5'
        - '21.02.7'
      architecture:
        description: '设备架构'
        required: true
        default: 'x86_64'
        type: choice
        options:
        - 'x86_64'
        - 'aarch64_generic'
        - 'arm_cortex-a9'

env:
  PACKAGE_NAME: network-switcher

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          libssl-dev \
          xsltproc \
          wget \
          unzip \
          python3 \
          python3-setuptools

    - name: 下载OpenWrt SDK
      run: |
        # 根据版本和架构下载对应的SDK
        if [ "${{ inputs.architecture }}" = "x86_64" ]; then
          SDK_URL="https://downloads.openwrt.org/releases/${{ inputs.openwrt_version }}/targets/x86/64/openwrt-sdk-${{ inputs.openwrt_version }}-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
        elif [ "${{ inputs.architecture }}" = "aarch64_generic" ]; then
          SDK_URL="https://downloads.openwrt.org/releases/${{ inputs.openwrt_version }}/targets/armvirt/64/openwrt-sdk-${{ inputs.openwrt_version }}-aarch64_generic_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
        elif [ "${{ inputs.architecture }}" = "arm_cortex-a9" ]; then
          SDK_URL="https://downloads.openwrt.org/releases/${{ inputs.openwrt_version }}/targets/mvebu/cortexa9/openwrt-sdk-${{ inputs.openwrt_version }}-mvebu-cortexa9_gcc-11.2.0_musl_eabi.Linux-x86_64.tar.xz"
        fi
        
        wget -O sdk.tar.xz "$SDK_URL"
        tar -xf sdk.tar.xz
        SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -1)
        echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV
        echo "使用SDK目录: $SDK_DIR"

    - name: 准备包目录
      run: |
        mkdir -p $SDK_DIR/package/$PACKAGE_NAME
        # 复制所有文件到包目录
        cp -r ./* $SDK_DIR/package/$PACKAGE_NAME/
        # 确保Makefile有执行权限
        chmod +x $SDK_DIR/package/$PACKAGE_NAME/Makefile

    - name: 编译IPK包
      working-directory: $SDK_DIR
      run: |
        # 更新feeds
        ./scripts/feeds update -a
        
        # 配置包
        echo "CONFIG_PACKAGE_${PACKAGE_NAME}=m" >> .config
        make defconfig
        
        echo "开始编译包..."
        # 编译特定包
        make package/$PACKAGE_NAME/compile V=99
        
        # 检查编译结果
        if [ $? -eq 0 ]; then
          echo "✅ 编译成功!"
        else
          echo "❌ 编译失败!"
          exit 1
        fi

    - name: 查找生成的IPK文件
      run: |
        # 在bin目录中查找IPK文件
        IPK_PATH=$(find $SDK_DIR/bin -name "*${PACKAGE_NAME}*.ipk" -type f)
        if [ -n "$IPK_PATH" ]; then
          echo "找到IPK文件: $IPK_PATH"
          echo "IPK_PATH=$IPK_PATH" >> $GITHUB_ENV
        else
          echo "未找到IPK文件!"
          # 列出bin目录内容帮助调试
          find $SDK_DIR/bin -type f -name "*.ipk" | head -10
          exit 1
        fi

    - name: 上传IPK文件
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-${{ inputs.openwrt_version }}-${{ inputs.architecture }}
        path: ${{ env.IPK_PATH }}
        retention-days: 30

    - name: 显示构建信息
      if: always()
      run: |
        echo "=== 构建完成 ==="
        echo "包名称: $PACKAGE_NAME"
        echo "版本: ${{ inputs.openwrt_version }}"
        echo "架构: ${{ inputs.architecture }}"
        echo "状态: ${{ job.status }}"
        if [ "${{ job.status }}" = "success" ]; then
          echo "IPK文件已上传到Artifacts"
          echo "文件: $IPK_PATH"
        fi
